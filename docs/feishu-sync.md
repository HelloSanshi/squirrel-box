# 飞书同步功能说明

## 功能概述

松鼠收藏夹现在支持将收藏的内容自动同步到飞书文档,让你的收藏内容可以在飞书中管理和查看。

## 配置步骤

### 1. 创建飞书机器人

1. 访问 [飞书开放平台](https://open.feishu.cn/app)
2. 点击"创建企业自建应用"
3. 填写应用名称和描述
4. 创建成功后,在"凭证与基础信息"页面获取:
   - **App ID** (形如 `cli_xxxxxxxxxx`)
   - **App Secret**

### 2. 配置权限

在应用管理后台:

1. 进入"权限管理"页面
2. 添加以下权限:
   - `docs:doc` - 文档读写权限
   - `sheets:spreadsheet` - 表格读写权限
3. 点击"发布版本"使权限生效

### 3. 创建目标文档

1. 在飞书中创建一个新的文档、表格或知识库
   - 新版文档 (*.feishu.cn/docx/*)
   - 旧版文档 (*.feishu.cn/docs/*)
   - 电子表格 (*.feishu.cn/sheets/*)
   - 知识库 (*.feishu.cn/wiki/*)
2. 将机器人添加为文档应用:
   - 点击文档右上角的"三个点"(更多)
   - 选择"添加文档应用"
   - 搜索并选择你创建的机器人应用
   - 确认添加

### 4. 在插件中配置

1. 打开松鼠收藏夹设置页面
2. 找到"飞书同步"部分
3. 填写配置信息:
   - **App ID**: 从步骤1获取
   - **App Secret**: 从步骤1获取
   - 点击"测试连接"验证配置
4. 粘贴文档链接:
   - 复制飞书文档的完整链接
   - 粘贴到"飞书文档链接"输入框
   - 插件会自动解析文档 Token 和类型
5. 开启自动同步(可选):
   - 勾选"自动同步到飞书"
   - 每次收藏新内容时会自动同步

## 使用方式

### 自动同步

开启"自动同步到飞书"后:
- 每次收藏新内容时,会自动同步到飞书文档
- 同步失败不会影响收藏功能
- 查看浏览器控制台可以看到同步日志

### 手动同步

在侧边栏顶部:
- 云图标按钮:点击手动同步当前筛选的内容
- 绿色云图标:表示自动同步已开启
- 灰色云图标:表示自动同步已关闭
- 加载动画:表示正在同步

## 同步内容格式

### 文档格式 (docx/docs)

每条收藏会以 Markdown 格式追加到文档末尾:

```markdown
### 作者名 · 平台

**分类**: 技术
**时间**: 2025-11-30 12:00:00

**摘要**:
这是AI生成的摘要内容...

**原文**:
原始推文或笔记内容...

**关键词**: #关键词1 #关键词2

**原文链接**: https://...

---
```

### 表格格式 (sheets)

每条收藏会作为新行追加到表格:

| 时间 | 作者 | 平台 | 分类 | 摘要 | 原文 | 关键词 | 链接 |
|------|------|------|------|------|------|--------|------|
| ... | ... | ... | ... | ... | ... | ... | ... |

## 常见问题

### Q: 同步失败怎么办?

1. 检查 App ID 和 App Secret 是否正确
2. 确认应用权限已配置并发布
3. 确认机器人已添加为文档协作者
4. 查看浏览器控制台的错误信息

### Q: 支持哪些文档类型?

- ✅ 新版文档 (docx)
- ✅ 旧版文档 (docs)
- ✅ 电子表格 (sheets)
- ✅ 知识库 (wiki)

### Q: 会同步历史收藏吗?

手动同步会同步当前筛选的所有内容。
自动同步只同步新收藏的内容。

### Q: 同步会覆盖已有内容吗?

不会。所有内容都是追加到文档末尾,不会影响已有内容。

### Q: 如何只同步部分内容?

使用侧边栏的筛选功能(平台、分类),然后点击手动同步按钮。

## 技术细节

### API 调用

- 使用飞书开放平台 API
- 通过 tenant_access_token 鉴权
- 支持批量追加内容
- 通过 background service worker 调用 API,避免 CORS 限制

### 数据安全

- App Secret 加密存储在本地
- 仅在同步时调用飞书 API
- 不会上传到其他服务器
- 所有 API 调用在 background 中执行

### 错误处理

- 同步失败不会影响收藏功能
- 详细的错误日志记录
- 自动降级处理

## 未来计划

- [ ] 支持双向同步
- [ ] 支持自定义同步格式
- [ ] 支持飞书云文档
- [ ] 支持批量同步历史记录
- [ ] 支持同步到多个文档
